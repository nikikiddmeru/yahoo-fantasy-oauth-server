<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yahoo Fantasy Draft Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 text-white">
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">Yahoo Fantasy Draft Companion</h1>
            <p class="text-purple-200">League ID: 268821 | 14 Teams | SuperFlex</p>
        </div>

        <div class="bg-green-500/20 border border-green-500/50 rounded-lg p-4 mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                    <span id="connectionStatus">âœ… Connected to Yahoo Fantasy API</span>
                </div>
                <button onclick="syncPlayers()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    ðŸ”„ Sync Players
                </button>
            </div>
            
            <!-- CSV Upload -->
            <div class="mt-4 pt-4 border-t border-green-500/30">
                <label for="csvUpload" class="block text-sm font-medium mb-2">Upload FantasyPros CSV (Optional)</label>
                <input type="file" id="csvUpload" accept=".csv" onchange="handleCsvUpload(event)" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-600 file:text-white hover:file:bg-blue-700"/>
                <p class="text-xs text-green-200 mt-1">Upload your FantasyPros 2025 rankings CSV to get all 515 players instead of just 10 demo players</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="space-y-6">
                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                        <h2 class="text-xl font-semibold">League Status</h2>
                    </div>
                    <div id="leagueInfo">
                        <button onclick="connectLeague()" id="connectBtn" class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition-colors">
                            Connect to League
                        </button>
                    </div>
                </div>

                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h2 class="text-xl font-semibold">My Team (<span id="teamCount">0</span>)</h2>
                    </div>
                    <div id="myTeamList" class="text-gray-300">
                        No players drafted yet
                    </div>
                </div>

                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6">
                    <h3 class="font-semibold mb-3">Filter by Position</h3>
                    <select id="positionFilter" onchange="filterRecommendations()" class="w-full bg-black/30 border border-gray-600 rounded-lg px-3 py-2">
                        <option value="ALL">All Positions</option>
                        <option value="QB">Quarterback</option>
                        <option value="RB">Running Back</option>
                        <option value="WR">Wide Receiver</option>
                        <option value="TE">Tight End</option>
                        <option value="DEF">Defense</option>
                    </select>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                        <h2 class="text-xl font-semibold">Recommended Picks</h2>
                    </div>
                    <div id="recommendationsList" class="space-y-4">
                        <div class="text-center py-8 text-gray-400">
                            Loading recommendations...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        var leagueData = null;
        var myTeam = [];
        var draftPicks = [];
        var allPlayers = [];
        var recommendations = [];
        var loading = false;

        // Your access token
        var ACCESS_TOKEN = '3Al3qWOd7lzB8IrP.iT.9EG7FxXOQ1Pgc2WItaH2j9ip73X_EUo0By5hly5zIljtXHqHW0shpBAHM7oQpVvYpOp7xyycB7rmEDgsMXdIEIfTJZTjq69r8597b3karfCMeURok0B1vqdAW3NT1QEFXrd4ftqJiAEfv06QZ4b6O4FAAi3TG1hW6A1RsB3C_KXC.KpZJXT5wXxWcF4Yv9vqc5xxbOl.xCOshG4sQzoteCS0qDwGPzVEyFSaeQitOFhy4uK3PcIwsbXdG9WTEoCImmL_J_Pn1dxM2.gnTematlGFPPx7pKyrhR8n1TnWYNC1rV47ExtJf3Lip3vjwMuVbiQoBHQo1ED3sSprhXXQst_ZrdWpwoGejAuaOz6pEcdrwTIsltMX3IyGoY8e_ooIcrRU81i6_v2MUAIZeWsat5McCxXfJa9uIj9Jf3I.QHc19sBunb4R6p.BZy2M2Rs6jP1soP_Efbtwgi_AJCXhaiSp4cpgafn9Rm6hNwOrAy7TLBMdVP9hhJysAH6jtYXpA6ria3U8ec0d5ByUImAeqy_JKqn5jZrwlGf34_kni1oF2im.4Iw7WH_hBmxCdqjAmH3Bk9GWuZ4zDxb9y3GCt9iSyPsqyJDPJC0wRIy_K4TxAwFMS_.4M8xnmQVtHXdUAHOlSlcliJ95Qn5pQfJygMmPGExzHfOQ5KeOIbzn1NXsxBIw0Q_cfh5tCVGOBcb.0.GGOejbwrimNY1pQduSgd_KQ7JvcTPeMReh.FS4E.sA4h0wAc6czjgJetrImncvWCrKwlRdUYsndQEM77cpI28xABhpWBDQs8ym542nCbdXWkp8MLwKVgNzDQ24gMtbEuteVTWg_QV8X4ruR2iB6eZuMiE.OrRzYmkHE80B0eo0MSp2Xd33mU9I7.clo.38thoKEX4YIw9sUErCoA--';

        // League configuration
        var LEAGUE_CONFIG = {
            id: '268821',
            teams: 14,
            positions: { QB: 1, WR: 2, RB: 2, TE: 1, FLEX: 1, SUPERFLEX: 1, DEF: 1, BENCH: 5 },
            playoffWeeks: [15, 16, 17]
        };

        // Enhanced mock data
        var mockPlayers = [
            { id: 1, name: 'Josh Allen', position: 'QB', team: 'BUF', rating: 99, sosRank: 19, playoffSos: 5, adp: 1.2, projected: 24.5, ecr: 1, upside: 'High', bust: 'Low', tier: 1 },
            { id: 2, name: 'Lamar Jackson', position: 'QB', team: 'BAL', rating: 96, sosRank: 25, playoffSos: 3, adp: 1.8, projected: 23.8, ecr: 2, upside: 'High', bust: 'Medium', tier: 1 },
            { id: 3, name: 'Justin Jefferson', position: 'WR', team: 'MIN', rating: 98, sosRank: 25, playoffSos: 8, adp: 0.8, projected: 19.2, ecr: 1, upside: 'High', bust: 'Low', tier: 1 },
            { id: 4, name: 'Cooper Kupp', position: 'WR', team: 'SEA', rating: 85, sosRank: 6, playoffSos: 12, adp: 4.8, projected: 16.2, ecr: 40, upside: 'Medium', bust: 'High', tier: 4 },
            { id: 5, name: 'Christian McCaffrey', position: 'RB', team: 'SF', rating: 97, sosRank: 5, playoffSos: 6, adp: 0.5, projected: 20.1, ecr: 1, upside: 'High', bust: 'Medium', tier: 1 },
            { id: 6, name: 'Austin Ekeler', position: 'RB', team: 'WAS', rating: 76, sosRank: 30, playoffSos: 20, adp: 8.3, projected: 12.4, ecr: 80, upside: 'Low', bust: 'High', tier: 8 },
            { id: 7, name: 'Travis Kelce', position: 'TE', team: 'KC', rating: 94, sosRank: 31, playoffSos: 4, adp: 2.8, projected: 16.2, ecr: 8, upside: 'Medium', bust: 'Medium', tier: 1 },
            { id: 8, name: 'Mark Andrews', position: 'TE', team: 'BAL', rating: 88, sosRank: 3, playoffSos: 9, adp: 3.2, projected: 14.5, ecr: 15, upside: 'Medium', bust: 'Medium', tier: 2 },
            { id: 9, name: 'Stefon Diggs', position: 'WR', team: 'HOU', rating: 91, sosRank: 8, playoffSos: 7, adp: 2.3, projected: 17.1, ecr: 12, upside: 'Medium', bust: 'Low', tier: 2 },
            { id: 10, name: 'Saquon Barkley', position: 'RB', team: 'PHI', rating: 87, sosRank: 19, playoffSos: 12, adp: 3.8, projected: 16.4, ecr: 25, upside: 'High', bust: 'Medium', tier: 3 }
        ];

        // Connect to league
        function connectLeague() {
            var btn = document.getElementById('connectBtn');
            var originalText = btn.textContent;
            
            btn.textContent = 'Connecting...';
            btn.disabled = true;
            loading = true;

            fetch('/api/yahoo-proxy?endpoint=league/nfl.l.' + LEAGUE_CONFIG.id, {
                headers: {
                    'Authorization': 'Bearer ' + ACCESS_TOKEN
                }
            }).then(function(response) {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('API call failed: ' + response.status);
                }
            }).then(function(data) {
                console.log('League data received:', data);
                
                var league = data.fantasy_content.league[0];
                leagueData = {
                    name: league.name,
                    size: league.num_teams,
                    draftStatus: league.draft_status,
                    currentPick: league.current_weekly_period || 1,
                    season: league.season
                };
                
                updateLeagueDisplay();
                generateRecommendations();
            }).catch(function(error) {
                console.error('Connection failed:', error);
                alert('Connection failed: ' + error.message + '. Loading demo data instead.');
                loadDemoData();
            }).finally(function() {
                btn.textContent = originalText;
                btn.disabled = false;
                loading = false;
            });
        }

        // Load demo data
        function loadDemoData() {
            leagueData = {
                name: 'Demo League (League 268821)',
                size: 14,
                draftStatus: 'in_progress',
                currentPick: Math.floor(Math.random() * 50) + 1,
                season: '2025'
            };
            
            allPlayers = mockPlayers.slice();
            updateLeagueDisplay();
            generateRecommendations();
        }

        // Update league display
        function updateLeagueDisplay() {
            if (leagueData) {
                document.getElementById('leagueInfo').innerHTML = 
                    '<div class="space-y-2">' +
                    '<p><strong>League:</strong> ' + leagueData.name + '</p>' +
                    '<p><strong>Teams:</strong> ' + leagueData.size + '</p>' +
                    '<p><strong>Current Pick:</strong> #' + leagueData.currentPick + '</p>' +
                    '<p><strong>Status:</strong> <span class="text-green-400">' + (leagueData.draftStatus || 'Connected') + '</span></p>' +
                    '<button onclick="connectLeague()" class="w-full mt-3 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition-colors">ðŸ”„ Refresh League</button>' +
                    '</div>';
            }
        }

        // Generate recommendations
        function generateRecommendations() {
            var availablePlayers = allPlayers.filter(function(player) {
                return !myTeam.some(function(teamPlayer) { return teamPlayer.id === player.id; });
            });

            var needs = Object.assign({}, LEAGUE_CONFIG.positions);
            myTeam.forEach(function(player) {
                if (needs[player.position] > 0) {
                    needs[player.position]--;
                }
            });

            recommendations = availablePlayers.map(function(player) {
                var score = 0;
                score += (player.rating / 100) * 40;
                score += (32 - player.sosRank) / 32 * 20;
                score += (32 - player.playoffSos) / 32 * 20;
                
                var positionNeed = needs[player.position] > 0 ? 1 : 0.2;
                score += positionNeed * 15;
                
                var competitionLevel = Math.floor(Math.random() * 5);
                score += Math.max(0, (5 - competitionLevel)) * 1;

                var reasons = [];
                if (player.rating >= 90) reasons.push('Elite talent');
                if (player.playoffSos <= 5) reasons.push('Easy playoff schedule');
                if (needs[player.position] > 0) reasons.push('Fills positional need');
                if (player.sosRank <= 10) reasons.push('Favorable season schedule');

                return {
                    id: player.id,
                    name: player.name,
                    position: player.position,
                    team: player.team,
                    rating: player.rating,
                    sosRank: player.sosRank,
                    playoffSos: player.playoffSos,
                    adp: player.adp,
                    projected: player.projected,
                    ecr: player.ecr,
                    upside: player.upside,
                    bust: player.bust,
                    tier: player.tier,
                    recommendationScore: Math.round(score * 10) / 10,
                    reason: reasons.length > 0 ? reasons.join(', ') : 'Solid value pick'
                };
            });

            recommendations.sort(function(a, b) { return b.recommendationScore - a.recommendationScore; });
            filterRecommendations();
        }

        // Filter recommendations
        function filterRecommendations() {
            var selectedPosition = document.getElementById('positionFilter').value;
            var filtered = selectedPosition === 'ALL' 
                ? recommendations 
                : recommendations.filter(function(p) { return p.position === selectedPosition; });

            displayRecommendations(filtered.slice(0, 10));
        }

        // Display recommendations
        function displayRecommendations(players) {
            var container = document.getElementById('recommendationsList');
            
            if (players.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400">No recommendations available</div>';
                return;
            }

            var html = '';
            for (var i = 0; i < players.length; i++) {
                var player = players[i];
                var upsideColor = player.upside === 'High' ? 'text-green-400' : player.upside === 'Low' ? 'text-red-400' : 'text-yellow-400';
                var bustColor = player.bust === 'High' ? 'text-red-400' : player.bust === 'Low' ? 'text-green-400' : 'text-yellow-400';
                
                html += '<div class="bg-white/5 rounded-lg p-4 hover:bg-white/10 transition-colors">' +
                    '<div class="flex items-center justify-between mb-2">' +
                        '<div class="flex items-center gap-3">' +
                            '<span class="bg-purple-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">' + (i + 1) + '</span>' +
                            '<div>' +
                                '<h3 class="font-semibold">' + player.name + '</h3>' +
                                '<p class="text-sm text-gray-300">' + player.team + ' - ' + player.position + ' (ECR: ' + (player.ecr || 'N/A') + ', Tier ' + (player.tier || 'N/A') + ')</p>' +
                            '</div>' +
                        '</div>' +
                        '<div class="text-right">' +
                            '<div class="text-lg font-bold text-green-400">' + player.recommendationScore + '</div>' +
                            '<div class="text-xs text-gray-400">Score</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-3">' +
                        '<div><span class="text-gray-400">Rating:</span> ' + player.rating + '</div>' +
                        '<div><span class="text-gray-400">SOS Rank:</span> ' + player.sosRank + '</div>' +
                        '<div><span class="text-gray-400">Playoff SOS:</span> ' + player.playoffSos + '</div>' +
                        '<div><span class="text-gray-400">ADP:</span> ' + player.adp + '</div>' +
                    '</div>' +
                    '<div class="grid grid-cols-2 gap-4 text-xs mb-3">' +
                        '<div><span class="text-gray-400">Upside:</span> <span class="' + upsideColor + '">' + (player.upside || 'Medium') + '</span></div>' +
                        '<div><span class="text-gray-400">Bust Risk:</span> <span class="' + bustColor + '">' + (player.bust || 'Medium') + '</span></div>' +
                    '</div>' +
                    '<div class="flex items-center justify-between">' +
                        '<p class="text-sm text-blue-300">' + player.reason + '</p>' +
                        '<button onclick="draftPlayer(' + player.id + ')" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">Draft Player</button>' +
                    '</div>' +
                '</div>';
            }
            
            container.innerHTML = html;
        }

        // Draft a player
        function draftPlayer(playerId) {
            var player = allPlayers.find(function(p) { return p.id === playerId; });
            if (player && !myTeam.some(function(p) { return p.id === playerId; })) {
                myTeam.push(player);
                updateMyTeamDisplay();
                generateRecommendations();
            }
        }

        // Update my team display
        function updateMyTeamDisplay() {
            var container = document.getElementById('myTeamList');
            var count = document.getElementById('teamCount');
            
            count.textContent = myTeam.length;
            
            if (myTeam.length === 0) {
                container.innerHTML = '<p class="text-gray-300">No players drafted yet</p>';
            } else {
                var html = '';
                for (var i = 0; i < myTeam.length; i++) {
                    var player = myTeam[i];
                    html += '<div class="flex justify-between items-center p-2 bg-green-500/20 rounded mb-2">' +
                        '<span>' + player.name + '</span>' +
                        '<span class="text-sm text-green-300">' + player.position + '</span>' +
                    '</div>';
                }
                container.innerHTML = html;
            }
        }

        // Sync players
        function syncPlayers() {
            if (leagueData) {
                generateRecommendations();
                alert('Players synced successfully!');
            } else {
                alert('Please connect to league first.');
            }
        }

        // Handle CSV file upload
        function handleCsvUpload(event) {
            var file = event.target.files[0];
            if (file && file.type === 'text/csv') {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var csvText = e.target.result;
                    processCsvText(csvText);
                };
                reader.readAsText(file);
            }
        }

        // Process uploaded CSV text with comprehensive error handling
        function processCsvText(csvText) {
            try {
                console.log('=== CSV PROCESSING START ===');
                console.log('CSV length:', csvText.length);
                console.log('First 500 characters:');
                console.log(csvText.substring(0, 500));
                
                if (!csvText || csvText.length < 50) {
                    throw new Error('CSV appears to be empty or too short');
                }
                
                var lines = csvText.split('\n');
                console.log('Total lines found:', lines.length);
                console.log('First line (headers):', lines[0]);
                console.log('Second line (sample data):', lines[1]);
                
                if (lines.length < 2) {
                    throw new Error('CSV appears to have no data rows');
                }
                
                // Parse headers with extra safety
                var headerLine = lines[0];
                if (headerLine.charCodeAt(0) === 0xFEFF) {
                    headerLine = headerLine.substring(1); // Remove BOM
                }
                
                var headers;
                try {
                    headers = headerLine.split(',').map(function(h) {
                        return h.trim().replace(/^"(.*)"$/, '$1').replace(/"/g, '');
                    });
                    console.log('Parsed headers:', headers);
                } catch (headerError) {
                    console.error('Header parsing error:', headerError);
                    throw new Error('Failed to parse CSV headers');
                }
                
                var fantasyProsData = [];
                var successCount = 0;
                var errorCount = 0;
                
                // Process data rows with individual error handling
                for (var i = 1; i < Math.min(lines.length, 520); i++) {
                    try {
                        var line = lines[i].trim();
                        if (!line) continue;
                        
                        // Simple split for now, can enhance later
                        var values = line.split(',').map(function(v) {
                            return v.trim().replace(/^"(.*)"$/, '$1');
                        });
                        
                        if (values.length >= 3) { // At least rank, name, team
                            var player = {};
                            
                            // Map values to headers safely
                            for (var j = 0; j < Math.min(headers.length, values.length); j++) {
                                try {
                                    var header = headers[j] || 'UNKNOWN_' + j;
                                    var value = values[j] || '';
                                    player[header] = value;
                                } catch (mappingError) {
                                    console.log('Mapping error for row', i, 'column', j, ':', mappingError);
                                }
                            }
                            
                            // Check if we have essential data
                            var playerName = player['PLAYER NAME'] || player['Player Name'] || player['NAME'] || '';
                            var team = player['TEAM'] || player['Team'] || '';
                            var position = player['POS'] || player['Position'] || '';
                            
                            if (playerName.length > 1 && team && position) {
                                // Normalize the player object
                                player['PLAYER NAME'] = playerName;
                                player['TEAM'] = team;
                                player['POS'] = position;
                                
                                fantasyProsData.push(player);
                                successCount++;
                            }
                        }
                        
                    } catch (rowError) {
                        errorCount++;
                        if (errorCount <= 5) {
                            console.log('Row', i, 'error:', rowError.message);
                        }
                    }
                }
                
                console.log('Processing complete:');
                console.log('- Successfully parsed:', successCount, 'players');
                console.log('- Errors encountered:', errorCount);
                
                if (successCount === 0) {
                    throw new Error('No valid players found in CSV. Check column names and data format.');
                }
                
                // Convert to our format
                console.log('Converting to app format...');
                convertFantasyProsData(fantasyProsData);
                
                // Update UI
                document.getElementById('connectionStatus').textContent = 'âœ… Loaded ' + successCount + ' FantasyPros 2025 Players';
                console.log('=== CSV PROCESSING SUCCESS ===');
                
            } catch (error) {
                console.error('=== CSV PROCESSING FAILED ===');
                console.error('Error:', error.message);
                console.error('Stack:', error.stack);
                alert('CSV Processing Error: ' + error.message + '\n\nCheck console (F12) for details. Using demo data instead.');
                loadDemoData();
            }
        }

        // Simpler CSV parser that handles most cases
        function parseSimpleCsvLine(line) {
            var result = [];
            var current = '';
            var inQuotes = false;
            
            for (var i = 0; i < line.length; i++) {
                var char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        // Handle escaped quotes
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            
            // Clean up the results
            for (var j = 0; j < result.length; j++) {
                result[j] = result[j].trim().replace(/^"(.*)"$/, '$1');
            }
            
            return result;
        }

        // Convert FantasyPros data to our format
        function convertFantasyProsData(fantasyProsData) {
            console.log('Converting', fantasyProsData.length, 'FantasyPros players to app format...');
            
            allPlayers = [];
            
            for (var i = 0; i < fantasyProsData.length; i++) {
                try {
                    var fp = fantasyProsData[i];
                    var team = fp['TEAM'] || 'FA';
                    var position = fp['POS'] || 'FLEX';
                    var playerName = fp['PLAYER NAME'] || 'Unknown Player';
                    var rank = parseInt(fp['RK']) || (i + 1);
                    
                    // Calculate rating from ECR (higher rank = lower rating)
                    var rating = Math.max(60, Math.min(99, 100 - (rank * 0.8)));
                    
                    // Parse SOS and other data
                    var seasonSos = fp['SOS SEASON'] ? parseInt(fp['SOS SEASON']) : (Math.floor(Math.random() * 32) + 1);
                    var playoffSos = Math.floor(Math.random() * 32) + 1;
                    
                    // Estimate ADP from ECR 
                    var adp = rank * 0.12;
                    
                    // Calculate projected points based on position and rank
                    var projected = 10;
                    if (position === 'QB') projected = Math.max(15, 28 - (rank * 0.15));
                    else if (position === 'RB') projected = Math.max(8, 22 - (rank * 0.12));  
                    else if (position === 'WR') projected = Math.max(8, 20 - (rank * 0.10));
                    else if (position === 'TE') projected = Math.max(6, 16 - (rank * 0.08));
                    else if (position === 'DST') projected = Math.max(5, 12 - (rank * 0.05));
                    else if (position === 'K') projected = Math.max(4, 10 - (rank * 0.03));
                    
                    allPlayers.push({
                        id: i + 1,
                        name: playerName,
                        position: position,
                        team: team,
                        rating: Math.round(rating),
                        sosRank: seasonSos,
                        playoffSos: playoffSos,
                        adp: Math.round(adp * 10) / 10,
                        projected: Math.round(projected * 10) / 10,
                        ecr: rank,
                        upside: fp['UPSIDE '] || fp['UPSIDE'] || 'Medium',
                        bust: fp['BUST '] || fp['BUST'] || 'Medium',
                        tier: parseInt(fp['TIERS']) || Math.ceil(rank / 10)
                    });
                } catch (playerError) {
                    console.log('Error converting player', i, ':', playerError.message);
                }
            }
            
            console.log('Successfully converted', allPlayers.length, 'players to app format');
            generateRecommendations();
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Yahoo Fantasy Draft Companion loaded');
            loadDemoData();
        });
    </script>
</body>
</html>
